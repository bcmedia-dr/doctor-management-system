<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å¸«ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 0 auto;
            max-width: 1400px;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-custom:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        .header-title {
            color: #667eea;
            font-weight: bold;
        }
        .badge-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="main-container">
            <h2 class="text-center header-title mb-4">
                <i class="bi bi-hospital"></i> é†«å¸«ç®¡ç†ç³»çµ±
            </h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">å¸³è™Ÿ</label>
                    <input type="text" class="form-control" id="username" required>
                    <small class="text-muted">ç®¡ç†å“¡: admin / ä¸€èˆ¬ç”¨æˆ¶: user</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç¢¼</label>
                    <input type="password" class="form-control" id="password" required>
                    <small class="text-muted">ç®¡ç†å“¡: admin123 / ä¸€èˆ¬ç”¨æˆ¶: user123</small>
                </div>
                <button type="submit" class="btn btn-custom w-100">ç™»å…¥</button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="main-container">
            <!-- æ¨™é¡Œåˆ— -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="header-title">
                    <i class="bi bi-hospital"></i> é†«å¸«ç®¡ç†ç³»çµ±
                </h1>
                <div>
                    <span id="userInfo" class="me-3"></span>
                    <button onclick="logout()" class="btn btn-outline-danger">
                        <i class="bi bi-box-arrow-right"></i> ç™»å‡º
                    </button>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">ç¸½é†«å¸«æ•¸</p>
                                <h3 id="totalCount">0</h3>
                            </div>
                            <i class="bi bi-people-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">å·²ç°½ç´„</p>
                                <h3 id="contractedCount">0</h3>
                            </div>
                            <i class="bi bi-file-earmark-check-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">åˆä½œä¸­</p>
                                <h3 id="cooperatingCount">0</h3>
                            </div>
                            <i class="bi bi-hand-thumbs-up-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">æ´½è«‡ä¸­</p>
                                <h3 id="negotiatingCount">0</h3>
                            </div>
                            <i class="bi bi-chat-dots-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœå°‹èˆ‡æ“ä½œå€ -->
            <div class="search-section">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <input type="text" class="form-control" id="searchInput" placeholder="ğŸ” æœå°‹å§“åã€é›»è©±ã€Email">
                    </div>
                    <div class="col-md-2 mb-2">
                        <select class="form-select" id="specialtyFilter">
                            <option value="">æ‰€æœ‰ç§‘åˆ¥</option>
                            <option value="å…§ç§‘">å…§ç§‘</option>
                            <option value="å¤–ç§‘">å¤–ç§‘</option>
                            <option value="å°å…’ç§‘">å°å…’ç§‘</option>
                            <option value="éª¨ç§‘">éª¨ç§‘</option>
                            <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                            <option value="çœ¼ç§‘">çœ¼ç§‘</option>
                            <option value="çš®è†šç§‘">çš®è†šç§‘</option>
                            <option value="ç‰™ç§‘">ç‰™ç§‘</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <select class="form-select" id="genderFilter">
                            <option value="">æ‰€æœ‰æ€§åˆ¥</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <select class="form-select" id="statusFilter">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="æ´½è«‡ä¸­">æ´½è«‡ä¸­</option>
                            <option value="å·²ç°½ç´„">å·²ç°½ç´„</option>
                            <option value="åˆä½œä¸­">åˆä½œä¸­</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button onclick="addDoctor()" class="btn btn-custom me-2">
                            <i class="bi bi-plus-circle"></i> æ–°å¢é†«å¸«
                        </button>
                        <button onclick="exportExcel()" class="btn btn-success">
                            <i class="bi bi-file-earmark-excel"></i> åŒ¯å‡º Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- é†«å¸«åˆ—è¡¨ -->
            <div class="table-container">
                <table class="table table-hover">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>å§“å</th>
                            <th>é›»è©±</th>
                            <th>Email</th>
                            <th>ç§‘åˆ¥</th>
                            <th>æ€§åˆ¥</th>
                            <th>ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="doctorList">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯é†«å¸« Modal -->
    <div class="modal fade" id="doctorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æ–°å¢é†«å¸«</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <input type="hidden" id="doctorId">
                        <div class="mb-3">
                            <label class="form-label">å§“å *</label>
                            <input type="text" class="form-control" id="doctorName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é›»è©±</label>
                            <input type="text" class="form-control" id="doctorPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="doctorEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç§‘åˆ¥</label>
                            <select class="form-select" id="doctorSpecialty">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å…§ç§‘">å…§ç§‘</option>
                                <option value="å¤–ç§‘">å¤–ç§‘</option>
                                <option value="å°å…’ç§‘">å°å…’ç§‘</option>
                                <option value="éª¨ç§‘">éª¨ç§‘</option>
                                <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                                <option value="çœ¼ç§‘">çœ¼ç§‘</option>
                                <option value="çš®è†šç§‘">çš®è†šç§‘</option>
                                <option value="ç‰™ç§‘">ç‰™ç§‘</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ€§åˆ¥</label>
                            <select class="form-select" id="doctorGender">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç‹€æ…‹</label>
                            <select class="form-select" id="doctorStatus">
                                <option value="æ´½è«‡ä¸­">æ´½è«‡ä¸­</option>
                                <option value="å·²ç°½ç´„">å·²ç°½ç´„</option>
                                <option value="åˆä½œä¸­">åˆä½œä¸­</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-custom" onclick="saveDoctor()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isAdmin = false;
        let currentDoctors = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            const response = await fetch('/check_auth');
            const data = await response.json();
            
            if (data.logged_in) {
                isAdmin = data.is_admin;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = `ğŸ‘¤ ${data.username} ${isAdmin ? '(ä¸»ç®¡)' : '(ä¸€èˆ¬)'}`;
                loadData();
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        }

        // ç™»å…¥
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const response = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            
            if (response.ok) {
                checkAuth();
            } else {
                alert('ç™»å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
            }
        });

        // ç™»å‡º
        async function logout() {
            await fetch('/logout', {method: 'POST'});
            checkAuth();
        }

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            await loadStats();
            await loadDoctors();
        }

        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            document.getElementById('totalCount').textContent = data.total;
            document.getElementById('contractedCount').textContent = data.contracted;
            document.getElementById('cooperatingCount').textContent = data.cooperating;
            document.getElementById('negotiatingCount').textContent = data.negotiating;
        }

        // è¼‰å…¥é†«å¸«åˆ—è¡¨
        async function loadDoctors() {
            const search = document.getElementById('searchInput').value;
            const specialty = document.getElementById('specialtyFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            const params = new URLSearchParams({search, specialty, gender, status});
            const response = await fetch(`/api/doctors?${params}`);
            currentDoctors = await response.json();
            
            renderDoctors();
        }

        // æ¸²æŸ“é†«å¸«åˆ—è¡¨
        function renderDoctors() {
            const tbody = document.getElementById('doctorList');
            tbody.innerHTML = '';
            
            currentDoctors.forEach(doctor => {
                const statusBadge = getStatusBadge(doctor.status);
                const row = `
                    <tr>
                        <td>${doctor.id}</td>
                        <td><strong>${doctor.name}</strong></td>
                        <td>${doctor.phone || '-'}</td>
                        <td>${doctor.email || '-'}</td>
                        <td>${doctor.specialty || '-'}</td>
                        <td>${doctor.gender || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editDoctor(${doctor.id})">
                                <i class="bi bi-pencil"></i> ç·¨è¼¯
                            </button>
                            ${isAdmin ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${doctor.id})">
                                <i class="bi bi-trash"></i> åˆªé™¤
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // å–å¾—ç‹€æ…‹æ¨™ç±¤
        function getStatusBadge(status) {
            const badges = {
                'æ´½è«‡ä¸­': '<span class="badge bg-warning text-dark">æ´½è«‡ä¸­</span>',
                'å·²ç°½ç´„': '<span class="badge bg-info">å·²ç°½ç´„</span>',
                'åˆä½œä¸­': '<span class="badge bg-success">åˆä½œä¸­</span>'
            };
            return badges[status] || status;
        }

        // æ–°å¢é†«å¸«
        function addDoctor() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢é†«å¸«';
            document.getElementById('doctorForm').reset();
            document.getElementById('doctorId').value = '';
            new bootstrap.Modal(document.getElementById('doctorModal')).show();
        }

        // ç·¨è¼¯é†«å¸«
        function editDoctor(id) {
            const doctor = currentDoctors.find(d => d.id === id);
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯é†«å¸«';
            document.getElementById('doctorId').value = doctor.id;
            document.getElementById('doctorName').value = doctor.name;
            document.getElementById('doctorPhone').value = doctor.phone || '';
            document.getElementById('doctorEmail').value = doctor.email || '';
            document.getElementById('doctorSpecialty').value = doctor.specialty || '';
            document.getElementById('doctorGender').value = doctor.gender || '';
            document.getElementById('doctorStatus').value = doctor.status || '';
            new bootstrap.Modal(document.getElementById('doctorModal')).show();
        }

        // å„²å­˜é†«å¸«
        async function saveDoctor() {
            const id = document.getElementById('doctorId').value;
            const data = {
                name: document.getElementById('doctorName').value,
                phone: document.getElementById('doctorPhone').value,
                email: document.getElementById('doctorEmail').value,
                specialty: document.getElementById('doctorSpecialty').value,
                gender: document.getElementById('doctorGender').value,
                status: document.getElementById('doctorStatus').value
            };
            
            const url = id ? `/api/doctors/${id}` : '/api/doctors';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('doctorModal')).hide();
                loadData();
            } else {
                alert('å„²å­˜å¤±æ•—ï¼');
            }
        }

        // åˆªé™¤é†«å¸«
        async function deleteDoctor(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½é†«å¸«å—ï¼Ÿ')) return;
            
            const response = await fetch(`/api/doctors/${id}`, {method: 'DELETE'});
            
            if (response.ok) {
                loadData();
            } else {
                const data = await response.json();
                alert(data.error || 'åˆªé™¤å¤±æ•—ï¼');
            }
        }

        // åŒ¯å‡º Excel
        async function exportExcel() {
            window.location.href = '/api/export';
        }

        // ç›£è½ç¯©é¸è®ŠåŒ–
        document.getElementById('searchInput').addEventListener('input', loadDoctors);
        document.getElementById('specialtyFilter').addEventListener('change', loadDoctors);
        document.getElementById('genderFilter').addEventListener('change', loadDoctors);
        document.getElementById('statusFilter').addEventListener('change', loadDoctors);

        // åˆå§‹åŒ–
        checkAuth();
    </script>
</body>
</html>

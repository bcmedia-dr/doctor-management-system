<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«å¸«ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 0 auto;
            max-width: 1400px;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-custom:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        .header-title {
            color: #667eea;
            font-weight: bold;
        }
        .badge-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
        }
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .search-section .form-control,
        .search-section .form-select {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        .search-section .form-control:focus,
        .search-section .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-group.small {
            flex: 0 0 auto;
            min-width: 120px;
        }
        .filter-group.search {
            flex: 0 0 auto;
            min-width: 180px;
            max-width: 220px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: nowrap;
            flex: 0 0 auto;
            align-items: center;
        }
        .action-buttons .btn {
            white-space: nowrap;
            min-width: fit-content;
            flex-shrink: 0;
            padding: 8px 12px;
            font-size: 14px;
        }
        .filter-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            .filter-group {
                flex: 1 1 100%;
            }
            .action-buttons {
                justify-content: stretch;
                flex-wrap: wrap;
            }
            .action-buttons .btn {
                flex: 1 1 auto;
                min-width: 120px;
            }
        }
        
        /* è¡¨æ ¼æ•´é«”å„ªåŒ– */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table {
            width: 100%;
            min-width: 1200px; /* ç¢ºä¿è¡¨æ ¼æœ€å°å¯¬åº¦ */
            table-layout: fixed; /* å›ºå®šè¡¨æ ¼ä½ˆå±€ */
        }
        
        /* æ¬„ä½å¯¬åº¦åˆ†é… */
        .table colgroup col:nth-child(1) { width: 4%; }   /* ç·¨è™Ÿ */
        .table colgroup col:nth-child(2) { width: 8%; }   /* é†«å¸« */
        .table colgroup col:nth-child(3) { width: 7%; }   /* ç§‘åˆ¥ */
        .table colgroup col:nth-child(4) { width: 5%; }   /* æ€§åˆ¥ */
        .table colgroup col:nth-child(5) { width: 7%; }   /* ç‹€æ…‹ */
        .table colgroup col:nth-child(6) { width: 8%; }   /* è¯çµ¡çª—å£ */
        .table colgroup col:nth-child(7) { width: 18%; }  /* åˆä½œå“ç‰Œ - æœ€å¯¬ */
        .table colgroup col:nth-child(8) { width: 10%; }  /* å ±åƒ¹å€é–“ */
        .table colgroup col:nth-child(9) { width: 7%; }   /* ç¶“ç‡Ÿç¤¾ç¾¤ */
        .table colgroup col:nth-child(10) { width: 10%; } /* é†«å¸«ç¤¾ç¾¤ */
        .table colgroup col:nth-child(11) { width: 16%; } /* æ“ä½œ */
        
        /* å„²å­˜æ ¼æ¨£å¼ */
        .table td, .table th {
            padding: 12px 8px;
            vertical-align: middle;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* æ–‡å­—è™•ç† */
        .table td {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* æ¨™é¡Œä¸æ›è¡Œ */
        .table th {
            white-space: nowrap;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginContainer" class="login-container" style="display: none;">
        <div class="main-container">
            <h2 class="text-center header-title mb-4">
                <i class="bi bi-hospital"></i> é†«å¸«ç®¡ç†ç³»çµ±
            </h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">å¸³è™Ÿ</label>
                    <input type="text" class="form-control" id="username" required>
                    <small class="text-muted">ç®¡ç†å“¡: admin / ä¸€èˆ¬ç”¨æˆ¶: user</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">å¯†ç¢¼</label>
                    <input type="password" class="form-control" id="password" required>
                    <small class="text-muted">ç®¡ç†å“¡: admin123 / ä¸€èˆ¬ç”¨æˆ¶: user123</small>
                </div>
                <button type="submit" class="btn btn-custom w-100">ç™»å…¥</button>
            </form>
        </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="mainContainer" class="container" style="display: none;">
        <div class="main-container">
            <!-- æ¨™é¡Œåˆ— -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="header-title">
                    <i class="bi bi-hospital"></i> é†«å¸«ç®¡ç†ç³»çµ±
                </h1>
                <div>
                    <span id="userInfo" class="me-3"></span>
                    <button onclick="logout()" class="btn btn-outline-danger">
                        <i class="bi bi-box-arrow-right"></i> ç™»å‡º
                    </button>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">ç¸½é†«å¸«æ•¸</p>
                                <h3 id="totalCount">0</h3>
                            </div>
                            <i class="bi bi-people-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">å·²ç°½ç´„</p>
                                <h3 id="contractedCount">0</h3>
                            </div>
                            <i class="bi bi-file-earmark-check-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0">åˆä½œé</p>
                                <h3 id="cooperatedCount">0</h3>
                            </div>
                            <i class="bi bi-clock-history" style="font-size: 3rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœå°‹èˆ‡æ“ä½œå€ -->
            <div class="search-section">
                <!-- ç¯©é¸å€åŸŸèˆ‡æŒ‰éˆ• -->
                <div class="filter-row">
                    <div class="filter-group search">
                        <input type="text" class="form-control" id="searchInput" placeholder="ğŸ” æœå°‹é†«å¸«">
                    </div>
                    <div class="filter-group">
                        <select class="form-select" id="specialtyFilter">
                            <option value="">æ‰€æœ‰ç§‘åˆ¥</option>
                            <option value="å°å…’ç§‘">å°å…’ç§‘</option>
                            <option value="å®¶é†«ç§‘">å®¶é†«ç§‘</option>
                            <option value="è€³é¼»å–‰ç§‘">è€³é¼»å–‰ç§‘</option>
                            <option value="å…§ç§‘">å…§ç§‘</option>
                            <option value="å¤–ç§‘">å¤–ç§‘</option>
                            <option value="é†«ç¾">é†«ç¾</option>
                            <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                            <option value="çš®è†šç§‘">çš®è†šç§‘</option>
                            <option value="æ³Œå°¿ç§‘">æ³Œå°¿ç§‘</option>
                            <option value="ç²¾ç¥ç§‘">ç²¾ç¥ç§‘</option>
                            <option value="ä¸­é†«å¸«">ä¸­é†«å¸«</option>
                            <option value="ç‡Ÿé¤Šå¸«">ç‡Ÿé¤Šå¸«</option>
                            <option value="å¾©å¥ç§‘">å¾©å¥ç§‘</option>
                            <option value="è…è‡Ÿç§‘">è…è‡Ÿç§‘</option>
                            <option value="å¿ƒè‡Ÿç§‘">å¿ƒè‡Ÿç§‘</option>
                            <option value="ç¥ç¶“ç§‘">ç¥ç¶“ç§‘</option>
                        </select>
                    </div>
                    <div class="filter-group small">
                        <select class="form-select" id="genderFilter">
                            <option value="">æ‰€æœ‰æ€§åˆ¥</option>
                            <option value="ç”·">ç”·</option>
                            <option value="å¥³">å¥³</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select class="form-select" id="statusFilter">
                            <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                            <option value="å·²ç°½ç´„">å·²ç°½ç´„</option>
                            <option value="åˆä½œé">åˆä½œé</option>
                            <option value="è¯ç¹«é">è¯ç¹«é</option>
                            <option value="æœ‰ç¶“ç´€">æœ‰ç¶“ç´€</option>
                            <option value="æœªè¯ç¹«">æœªè¯ç¹«</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <select class="form-select" id="hasSocialMediaFilter">
                            <option value="">ç¶“ç‡Ÿç¤¾ç¾¤</option>
                            <option value="æ˜¯">æ˜¯</option>
                            <option value="å¦">å¦</option>
                        </select>
                    </div>
                    <!-- æ“ä½œæŒ‰éˆ•å€åŸŸ -->
                    <div class="action-buttons">
                        <button onclick="addDoctor()" class="btn btn-custom">
                            <i class="bi bi-plus-circle"></i> æ–°å¢é†«å¸«
                        </button>
                        <button id="importExcelBtn" onclick="document.getElementById('fileInput').click()" class="btn btn-info" style="display: none;">
                            <i class="bi bi-file-earmark-arrow-up"></i> åŒ¯å…¥ Excel
                        </button>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="importExcel(event)">
                        <button id="exportExcelBtn" onclick="exportExcel()" class="btn btn-success" style="display: none;">
                            <i class="bi bi-file-earmark-excel"></i> åŒ¯å‡º Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- é†«å¸«åˆ—è¡¨ -->
            <div class="table-container">
                <table class="table table-hover">
                    <colgroup>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col>
                        <col> <!-- åˆä½œå“ç‰Œ -->
                        <col>
                        <col>
                        <col>
                        <col>
                    </colgroup>
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>é†«å¸«</th>
                            <th>ç§‘åˆ¥</th>
                            <th>æ€§åˆ¥</th>
                            <th>ç‹€æ…‹</th>
                            <th>è¯çµ¡çª—å£</th>
                            <th>åˆä½œå“ç‰Œ</th>
                            <th>å ±åƒ¹å€é–“</th>
                            <th>ç¶“ç‡Ÿç¤¾ç¾¤</th>
                            <th>é†«å¸«ç¤¾ç¾¤</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="doctorList">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯é†«å¸« Modal -->
    <div class="modal fade" id="doctorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">æ–°å¢é†«å¸«</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="doctorForm">
                        <input type="hidden" id="doctorId">
                        <div class="mb-3">
                            <label class="form-label">é†«å¸«</label>
                            <input type="text" class="form-control" id="doctorEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç§‘åˆ¥</label>
                            <select class="form-select" id="doctorSpecialty">
                                <option value="">è«‹é¸æ“‡ç§‘åˆ¥</option>
                                <option value="å°å…’ç§‘">å°å…’ç§‘</option>
                                <option value="å®¶é†«ç§‘">å®¶é†«ç§‘</option>
                                <option value="è€³é¼»å–‰ç§‘">è€³é¼»å–‰ç§‘</option>
                                <option value="å…§ç§‘">å…§ç§‘</option>
                                <option value="å¤–ç§‘">å¤–ç§‘</option>
                                <option value="é†«ç¾">é†«ç¾</option>
                                <option value="å©¦ç”¢ç§‘">å©¦ç”¢ç§‘</option>
                                <option value="çš®è†šç§‘">çš®è†šç§‘</option>
                                <option value="æ³Œå°¿ç§‘">æ³Œå°¿ç§‘</option>
                                <option value="ç²¾ç¥ç§‘">ç²¾ç¥ç§‘</option>
                                <option value="ä¸­é†«å¸«">ä¸­é†«å¸«</option>
                                <option value="ç‡Ÿé¤Šå¸«">ç‡Ÿé¤Šå¸«</option>
                                <option value="å¾©å¥ç§‘">å¾©å¥ç§‘</option>
                                <option value="è…è‡Ÿç§‘">è…è‡Ÿç§‘</option>
                                <option value="å¿ƒè‡Ÿç§‘">å¿ƒè‡Ÿç§‘</option>
                                <option value="ç¥ç¶“ç§‘">ç¥ç¶“ç§‘</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">æ€§åˆ¥</label>
                            <select class="form-select" id="doctorGender">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="ç”·">ç”·</option>
                                <option value="å¥³">å¥³</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç‹€æ…‹</label>
                            <select class="form-select" id="doctorStatus">
                                <option value="å·²ç°½ç´„">å·²ç°½ç´„</option>
                                <option value="åˆä½œé">åˆä½œé</option>
                                <option value="è¯ç¹«é">è¯ç¹«é</option>
                                <option value="æœ‰ç¶“ç´€">æœ‰ç¶“ç´€</option>
                                <option value="æœªè¯ç¹«">æœªè¯ç¹«</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è¯çµ¡çª—å£</label>
                            <select class="form-select" id="doctorContactPerson">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="Nathan">Nathan</option>
                                <option value="Chloe">Chloe</option>
                                <option value="Tim">Tim</option>
                                <option value="Tiffany">Tiffany</option>
                                <option value="å…¬å¸">å…¬å¸</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">åˆä½œå“ç‰Œ</label>
                            <input type="text" class="form-control" id="doctorCurrentBrand" placeholder="è«‹è¼¸å…¥åˆä½œå“ç‰Œ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç¶“ç‡Ÿç¤¾ç¾¤</label>
                            <select class="form-select" id="doctorHasSocialMedia">
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="æ˜¯">æ˜¯</option>
                                <option value="å¦">å¦</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å ±åƒ¹å€é–“</label>
                            <input type="text" class="form-control" id="doctorPriceRange" placeholder="ä¾‹å¦‚ï¼š10,000-50,000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é†«å¸«ç¤¾ç¾¤</label>
                            <input type="url" class="form-control" id="doctorSocialMediaLink" placeholder="è«‹è¼¸å…¥é€£çµç¶²å€">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-custom" onclick="saveDoctor()">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isAdmin = false;
        let currentDoctors = [];

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            const response = await fetch('/check_auth');
            const data = await response.json();
            
            if (data.logged_in) {
                isAdmin = data.is_admin;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userInfo').textContent = `ğŸ‘¤ ${data.username} ${isAdmin ? '(ä¸»ç®¡)' : '(ä¸€èˆ¬)'}`;
                // åªæœ‰ç®¡ç†å‘˜æ‰æ˜¾ç¤ºå¯¼å‡ºExcelæŒ‰é’®
                document.getElementById('importExcelBtn').style.display = isAdmin ? 'inline-block' : 'none';
                document.getElementById('exportExcelBtn').style.display = isAdmin ? 'inline-block' : 'none';
                loadData();
            } else {
                document.getElementById('loginContainer').style.display = 'block';
                document.getElementById('mainContainer').style.display = 'none';
            }
        }

        // ç™»å…¥
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const response = await fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password})
            });
            
            if (response.ok) {
                checkAuth();
            } else {
                alert('ç™»å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
            }
        });

        // ç™»å‡º
        async function logout() {
            await fetch('/logout', {method: 'POST'});
            checkAuth();
        }

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            await loadStats();
            await loadDoctors();
            // åªåœ¨åˆå§‹è¼‰å…¥æ™‚æ›´æ–°ç§‘åˆ¥å»ºè­°åˆ—è¡¨
            if (!window.specialtySuggestionsLoaded) {
                await updateSpecialtySuggestions();
                window.specialtySuggestionsLoaded = true;
            }
        }

        // è¼‰å…¥çµ±è¨ˆ
        async function loadStats() {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            document.getElementById('totalCount').textContent = data.total;
            document.getElementById('contractedCount').textContent = data.contracted;
            document.getElementById('cooperatedCount').textContent = data.cooperated;
        }

        // è¼‰å…¥é†«å¸«åˆ—è¡¨
        async function loadDoctors() {
            const search = document.getElementById('searchInput').value;
            const specialty = document.getElementById('specialtyFilter').value;
            const gender = document.getElementById('genderFilter').value;
            const status = document.getElementById('statusFilter').value;
            const hasSocialMedia = document.getElementById('hasSocialMediaFilter').value;
            
            const params = new URLSearchParams({search, specialty, gender, status});
            if (hasSocialMedia) {
                params.append('has_social_media', hasSocialMedia);
            }
            const response = await fetch(`/api/doctors?${params}`);
            currentDoctors = await response.json();
            
            renderDoctors();
        }

        // æ›´æ–°ç§‘åˆ¥é¸å–®ï¼ˆå‹•æ…‹æ·»åŠ æ–°ç§‘åˆ¥ï¼‰
        async function updateSpecialtySuggestions() {
            // ç²å–æ‰€æœ‰é†«å¸«è³‡æ–™ä»¥æå–ç§‘åˆ¥ï¼ˆä¸å—ç¯©é¸å½±éŸ¿ï¼‰
            const response = await fetch('/api/doctors');
            const allDoctors = await response.json();
            
            // æå–æ‰€æœ‰å”¯ä¸€çš„ç§‘åˆ¥
            const specialties = [...new Set(allDoctors.map(d => d.specialty).filter(s => s && s.trim()))];
            
            // é è¨­ç§‘åˆ¥é¸é …ï¼ˆæŒ‰é †åºï¼‰
            const defaultSpecialties = ['å°å…’ç§‘', 'å®¶é†«ç§‘', 'è€³é¼»å–‰ç§‘', 'å…§ç§‘', 'å¤–ç§‘', 'éª¨ç§‘', 'é†«ç¾', 'å©¦ç”¢ç§‘', 'çš®è†šç§‘', 'æ³Œå°¿ç§‘', 'ç²¾ç¥ç§‘', 'ä¸­é†«å¸«', 'ç‡Ÿé¤Šå¸«', 'å¾©å¥ç§‘', 'æ–°é™³ä»£è¬ç§‘', 'è…¸èƒƒç§‘', 'è…è‡Ÿç§‘', 'å¿ƒè‡Ÿç§‘', 'ç¥ç¶“ç§‘', 'è—¥å¸«', 'æ¤é«®'];
            const allSpecialties = [...new Set([...defaultSpecialties, ...specialties])];
            
            // æ›´æ–°ç¯©é¸é¸å–®
            const specialtyFilter = document.getElementById('specialtyFilter');
            const currentValue = specialtyFilter.value;
            specialtyFilter.innerHTML = '<option value="">æ‰€æœ‰ç§‘åˆ¥</option>';
            allSpecialties.forEach(spec => {
                const option = document.createElement('option');
                option.value = spec;
                option.textContent = spec;
                specialtyFilter.appendChild(option);
            });
            specialtyFilter.value = currentValue;
            
            // æ›´æ–°è¡¨å–®é¸å–®
            const doctorSpecialty = document.getElementById('doctorSpecialty');
            const currentFormValue = doctorSpecialty.value;
            doctorSpecialty.innerHTML = '<option value="">è«‹é¸æ“‡ç§‘åˆ¥</option>';
            allSpecialties.forEach(spec => {
                const option = document.createElement('option');
                option.value = spec;
                option.textContent = spec;
                doctorSpecialty.appendChild(option);
            });
            doctorSpecialty.value = currentFormValue;
        }

        // æ¸²æŸ“é†«å¸«åˆ—è¡¨
        function renderDoctors() {
            const tbody = document.getElementById('doctorList');
            tbody.innerHTML = '';
            
            currentDoctors.forEach((doctor, index) => {
                const statusBadge = getStatusBadge(doctor.status);
                const socialMediaLink = doctor.social_media_link ? 
                    `<a href="${doctor.social_media_link}" target="_blank" class="text-primary">
                        <i class="bi bi-link-45deg"></i> é€£çµ
                    </a>` : '-';
                // ä½¿ç”¨ç´¢å¼•+1ä½œä¸ºæ˜¾ç¤ºç¼–å·ï¼Œåˆ é™¤åè‡ªåŠ¨é€’è¡¥
                const displayNumber = index + 1;
                const row = `
                    <tr>
                        <td>${displayNumber}</td>
                        <td style="font-size: 0.9rem;">${doctor.email || doctor.name || '-'}</td>
                        <td>${doctor.specialty || '-'}</td>
                        <td>${doctor.gender || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${doctor.contact_person || '-'}</td>
                        <td>${doctor.current_brand || '-'}</td>
                        <td>${formatPriceRange(doctor.price_range)}</td>
                        <td>${doctor.has_social_media || '-'}</td>
                        <td>${socialMediaLink}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editDoctor(${doctor.id})">
                                <i class="bi bi-pencil"></i> ç·¨è¼¯
                            </button>
                            ${isAdmin ? `
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteDoctor(${doctor.id})">
                                <i class="bi bi-trash"></i> åˆªé™¤
                            </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // å–å¾—ç‹€æ…‹æ¨™ç±¤
        function getStatusBadge(status) {
            const badges = {
                'å·²ç°½ç´„': '<span class="badge bg-success">å·²ç°½ç´„</span>',
                'åˆä½œé': '<span class="badge bg-info">åˆä½œé</span>',
                'è¯ç¹«é': '<span class="badge bg-primary">è¯ç¹«é</span>',
                'æœ‰ç¶“ç´€': '<span class="badge bg-warning">æœ‰ç¶“ç´€</span>',
                'æœªè¯ç¹«': '<span class="badge bg-secondary">æœªè¯ç¹«</span>'
            };
            return badges[status] || status;
        }

        // æ ¼å¼åŒ–å ±åƒ¹å€é–“ï¼ˆæ·»åŠ åƒä½åˆ†éš”ç¬¦ï¼‰
        function formatPriceRange(priceRange) {
            if (!priceRange || priceRange === '-') return '-';
            
            // å˜—è©¦æå–æ•¸å­—éƒ¨åˆ†
            const numbers = priceRange.match(/\d+/g);
            if (!numbers) return priceRange;
            
            // å°‡æ•¸å­—æ ¼å¼åŒ–ç‚ºå¸¶åƒä½åˆ†éš”ç¬¦çš„æ ¼å¼
            let formatted = priceRange;
            numbers.forEach(num => {
                const formattedNum = parseInt(num).toLocaleString('zh-TW');
                formatted = formatted.replace(num, formattedNum);
            });
            
            return formatted;
        }

        // æ–°å¢é†«å¸«
        function addDoctor() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢é†«å¸«';
            document.getElementById('doctorForm').reset();
            document.getElementById('doctorId').value = '';
            new bootstrap.Modal(document.getElementById('doctorModal')).show();
        }

        // ç·¨è¼¯é†«å¸«
        function editDoctor(id) {
            const doctor = currentDoctors.find(d => d.id === id);
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯é†«å¸«';
            document.getElementById('doctorId').value = doctor.id;
            // å„ªå…ˆä½¿ç”¨ nameï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ email
            document.getElementById('doctorEmail').value = doctor.name || doctor.email || '';
            document.getElementById('doctorSpecialty').value = doctor.specialty || '';
            document.getElementById('doctorGender').value = doctor.gender || '';
            document.getElementById('doctorStatus').value = doctor.status || '';
            document.getElementById('doctorContactPerson').value = doctor.contact_person || '';
            document.getElementById('doctorHasSocialMedia').value = doctor.has_social_media || '';
            document.getElementById('doctorSocialMediaLink').value = doctor.social_media_link || '';
            document.getElementById('doctorCurrentBrand').value = doctor.current_brand || '';
            document.getElementById('doctorPriceRange').value = doctor.price_range || '';
            new bootstrap.Modal(document.getElementById('doctorModal')).show();
        }

        // å„²å­˜é†«å¸«
        async function saveDoctor() {
            const id = document.getElementById('doctorId').value;
            const doctorName = document.getElementById('doctorEmail').value; // é†«å¸«åç¨±
            const data = {
                name: doctorName,  // åŒæ™‚è¨­ç½® name å’Œ email
                email: doctorName,
                specialty: document.getElementById('doctorSpecialty').value,
                gender: document.getElementById('doctorGender').value,
                status: document.getElementById('doctorStatus').value,
                contact_person: document.getElementById('doctorContactPerson').value,
                has_social_media: document.getElementById('doctorHasSocialMedia').value,
                social_media_link: document.getElementById('doctorSocialMediaLink').value,
                current_brand: document.getElementById('doctorCurrentBrand').value,
                price_range: document.getElementById('doctorPriceRange').value
            };
            
            const url = id ? `/api/doctors/${id}` : '/api/doctors';
            const method = id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('doctorModal')).hide();
                loadData();
                updateSpecialtySuggestions();
            } else {
                const errorData = await response.json();
                alert('å„²å­˜å¤±æ•—ï¼\n' + (errorData.error || 'æœªçŸ¥éŒ¯èª¤'));
            }
        }

        // åˆªé™¤é†«å¸«
        async function deleteDoctor(id) {
            if (!isAdmin) {
                alert('åªæœ‰ä¸»ç®¡æ‰èƒ½åˆªé™¤é†«å¸«ï¼');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½é†«å¸«å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/doctors/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('åˆªé™¤æˆåŠŸï¼');
                    loadData();
                } else {
                    const errorData = await response.json();
                    alert('åˆªé™¤å¤±æ•—ï¼\n' + (errorData.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼\n' + error.message);
            }
        }

        // åŒ¯å…¥ Excel
        async function importExcel(event) {
            if (!isAdmin) {
                alert('åªæœ‰ä¸»ç®¡æ‰èƒ½åŒ¯å…¥Excelï¼');
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é¸æ“‡
                return;
            }
            
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆæ ¼å¼ï¼ˆåªæ”¯æ´ openpyxl æ”¯æ´çš„æ ¼å¼ï¼‰
            const allowedExtensions = ['.xlsx', '.xlsm', '.xltx', '.xltm'];
            const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!allowedExtensions.includes(fileExt)) {
                alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼\n\nè«‹é¸æ“‡ Excel æª”æ¡ˆï¼ˆæ”¯æ´æ ¼å¼ï¼š.xlsxã€.xlsmã€.xltxã€.xltmï¼‰\n\nå¦‚æœæ‚¨çš„æª”æ¡ˆæ˜¯ .xls æ ¼å¼ï¼Œè«‹å…ˆç”¨ Excel è½‰æ›ç‚º .xlsx æ ¼å¼ã€‚');
                event.target.value = '';
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆé™åˆ¶ 10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('æª”æ¡ˆéå¤§ï¼\n\nè«‹é¸æ“‡å°æ–¼ 10MB çš„æª”æ¡ˆã€‚');
                event.target.value = '';
                return;
            }
            
            if (file.size === 0) {
                alert('æª”æ¡ˆç‚ºç©ºï¼\n\nè«‹é¸æ“‡æœ‰æ•ˆçš„ Excel æª”æ¡ˆã€‚');
                event.target.value = '';
                return;
            }
            
            // ç¢ºèªåŒ¯å…¥
            if (!confirm(`ç¢ºå®šè¦åŒ¯å…¥æª”æ¡ˆã€Œ${file.name}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šå·²å­˜åœ¨çš„é†«å¸«ï¼ˆç›¸åŒåç¨±ï¼‰å°‡è¢«è·³éã€‚`)) {
                event.target.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    let message = `åŒ¯å…¥æˆåŠŸï¼\næˆåŠŸåŒ¯å…¥ ${result.success_count} ç­†è³‡æ–™`;
                    if (result.errors && result.errors.length > 0) {
                        message += `\n\nè­¦å‘Šï¼š\n${result.errors.slice(0, 10).join('\n')}`;
                        if (result.errors.length > 10) {
                            message += `\n... é‚„æœ‰ ${result.errors.length - 10} å€‹è­¦å‘Š`;
                        }
                    }
                    alert(message);
                    // é‡æ–°è¼‰å…¥é†«å¸«åˆ—è¡¨
                    loadDoctors();
                    loadStats();
                } else {
                    let errorMsg = 'åŒ¯å…¥å¤±æ•—ï¼';
                    if (result.error) {
                        errorMsg += '\n' + result.error;
                    }
                    if (result.message) {
                        errorMsg += '\n' + result.message;
                    }
                    if (result.errors && result.errors.length > 0) {
                        errorMsg += '\n\néŒ¯èª¤è©³æƒ…ï¼š\n' + result.errors.slice(0, 5).join('\n');
                        if (result.errors.length > 5) {
                            errorMsg += `\n... é‚„æœ‰ ${result.errors.length - 5} å€‹éŒ¯èª¤`;
                        }
                    }
                    alert(errorMsg);
                }
            } catch (error) {
                let errorMsg = 'åŒ¯å…¥å¤±æ•—ï¼\n\n';
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += 'ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦ã€‚';
                } else {
                    errorMsg += error.message;
                }
                alert(errorMsg);
            } finally {
                // æ¸…ç©ºæ–‡ä»¶é¸æ“‡ï¼Œå…è¨±é‡æ–°é¸æ“‡ç›¸åŒæª”æ¡ˆ
                event.target.value = '';
            }
        }

        // åŒ¯å‡º Excel
        async function exportExcel() {
            if (!isAdmin) {
                alert('åªæœ‰ä¸»ç®¡æ‰èƒ½åŒ¯å‡ºExcelï¼');
                return;
            }
            
            try {
                const response = await fetch('/api/export');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'é†«å¸«è³‡æ–™.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const errorData = await response.json();
                    alert('åŒ¯å‡ºå¤±æ•—ï¼\n' + (errorData.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åŒ¯å‡ºå¤±æ•—ï¼\n' + error.message);
            }
        }

        // ç›£è½ç¯©é¸è®ŠåŒ–
        document.getElementById('searchInput').addEventListener('input', loadDoctors);
        document.getElementById('specialtyFilter').addEventListener('change', loadDoctors);
        document.getElementById('genderFilter').addEventListener('change', loadDoctors);
        document.getElementById('statusFilter').addEventListener('change', loadDoctors);
        document.getElementById('hasSocialMediaFilter').addEventListener('change', loadDoctors);

        // åˆå§‹åŒ–
        checkAuth();
    </script>
</body>
</html>
